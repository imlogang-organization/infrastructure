version: 2.1 

parameters:
  namespace:
    default: "beemoviebotstage"
    type: string

jobs:
  terraform-plan:
    machine: true 
    resource_class: imlogang-organization-server/ubuntu-k8s
    steps:
      - checkout
      - run: 
          name: make envvars correct 
          command: |
            if [ $CIRCLE_BRANCH == "Main" ]; then
              echo 'export TF_VAR_client_id="'"${CLIENT_ID}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_beemoviebot="'"${BEEMOVIEBOT}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_pterotoken="'"${PteroToken}"'"' >> "$BASH_ENV"
            else
              echo 'export TF_VAR_client_id_staging="'"${CLIENT_ID_STAGING}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_beemoviebot_staging="'"${BEEMOVIEBOT_STAGING}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_pterotoken="'"${PteroToken}"'"' >> "$BASH_ENV"
            fi
      - run:
          name: terraform init
          command: |
            cd Kubernetes/Secrets
            terraform init
      - run: 
          name: make sure namespace managed
          command: |
            cd Kubernetes/Secrets
            terraform import kubernetes_namespace.<< pipeline.parameters.namespace >> << pipeline.parameters.namespace >>
      - run: 
          name: terraform plan
          command: |
            cd Kubernetes/Secrets 
            terraform plan -out plan.tf
      - persist_to_workspace:
          root: .
          paths:
            - .
  
  terraform-apply:
    machine: true
    resource_class: imlogang-organization-server/ubuntu-k8s
    steps:
      - run: 
          name: make envvars correct 
          command: |
            if [ $CIRCLE_BRANCH == "Main" ]; then
              echo 'export TF_VAR_client_id="'"${CLIENT_ID}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_beemoviebot="'"${BEEMOVIEBOT}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_pterotoken="'"${PteroToken}"'"' >> "$BASH_ENV"
            else
              echo 'export TF_VAR_client_id_staging="'"${CLIENT_ID_STAGING}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_beemoviebot_staging="'"${BEEMOVIEBOT_STAGING}"'"' >> "$BASH_ENV"
              echo 'export TF_VAR_pterotoken="'"${PteroToken}"'"' >> "$BASH_ENV"
            fi
      - attach_workspace:
          at: .
      - run:
          name: terraform apply
          command: |
            cd Kubernetes/Secrets 
            terraform apply -auto-approve "plan.tf"

workflows:
  terraform-beemoviebot-<< pipeline.parameters.namespace >>:
    jobs:
      - terraform-plan:
          context:
            - kubeconfig
            - beemoviebot
      - hold:
          type: approval
          requires:
            - terraform-plan
      - terraform-apply:
          requires:
            - hold
          context:
            - kubeconfig
            - beemoviebot